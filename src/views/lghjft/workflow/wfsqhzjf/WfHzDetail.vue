<template>
  <div class="print-wrapper">
    <!-- ä¸»ç”³è¯·è¡¨åŒºåŸŸï¼šæ‰“å°åœ¨ç¬¬ä¸€é¡µA4 -->
    <div class="main-form-container" id="print-area-main">
      <div class="title-section">
        <h1 class="form-title">ç”˜è‚ƒçœå·¥ä¼šç»è´¹æ±‡æ€»ç¼´çº³ç”³è¯·è¡¨</h1>
      </div>

      <!-- 1. åŸºç¡€ä¿¡æ¯è¡¨æ ¼ -->
      <table class="form-table">
        <tr>
          <th>ç”³è¯·æ±‡æ€»ç¼´è´¹å•ä½<br />ç¤¾ä¼šä¿¡ç”¨ä»£ç </th>
          <td>
            <!-- ğŸ”´ æ”¹ä¸ºä½¿ç”¨printModeFlag -->
            <input v-if="!printModeFlag" v-model="data.xyxdm" disabled class="form-input" />
            <span v-else class="form-input">{{ data.xyxdm || '' }}</span>
          </td>
          <th>ç”³è¯·æ±‡æ€»ç¼´è´¹<br />å•ä½å…¨ç§°</th>
          <td>
            <input v-if="!printModeFlag" v-model="data.dwqc" disabled class="form-input" />
            <span v-else class="form-input">{{ data.dwqc || '' }}</span>
          </td>
        </tr>
        <tr>
          <th>ä¸»ç®¡ç¨åŠ¡éƒ¨é—¨</th>
          <td>
            <input v-if="!printModeFlag" v-model="data.zgsbm" disabled class="form-input" />
            <span v-else class="form-input">{{ data.zgsbm || '' }}</span>
          </td>
          <th>ç¼´è´¹å•ä½åœ°å€</th>
          <td>
            <input v-if="!printModeFlag" v-model="data.dwdz" disabled class="form-input" />
            <span v-else class="form-input">{{ data.dwdz || '' }}</span>
          </td>
        </tr>
        <tr>
          <th>å·¥ä¼šæ³•äºº<br />ç™»è®°è¯ä»¶å·ç </th>
          <td>
            <input v-if="!printModeFlag" v-model="data.ghfrdjzjh" disabled class="form-input" />
            <span v-else class="form-input">{{ data.ghfrdjzjh || '' }}</span>
          </td>
          <th>ç¼´è´¹å•ä½<br />å·¥ä¼šå…¨ç§°</th>
          <td>
            <input v-if="!printModeFlag" v-model="data.ghqc" disabled class="form-input" />
            <span v-else class="form-input">{{ data.ghqc || '' }}</span>
          </td>
        </tr>
        <tr>
          <th>èŒå·¥æ€»äººæ•°</th>
          <td>
            <input v-if="!printModeFlag" v-model="data.zzgzs" disabled class="form-input" type="number" />
            <span v-else class="form-input">{{ data.zzgzs || '' }}</span>
          </td>
          <th>å·¥ä¼šä¼šå‘˜æ•°</th>
          <td>
            <input v-if="!printModeFlag" v-model="data.ghyhs" disabled class="form-input" type="number" />
            <span v-else class="form-input">{{ data.ghyhs || '' }}</span>
          </td>
        </tr>
        <tr>
          <th>å·¥ä¼šè´Ÿè´£äºº</th>
          <td>
            <input v-if="!printModeFlag" v-model="data.ghfzr" disabled class="form-input" />
            <span v-else class="form-input">{{ data.ghfzr || '' }}</span>
          </td>
          <th>è”ç³»ç”µè¯</th>
          <td>
            <input v-if="!printModeFlag" v-model="data.lxdh" disabled class="form-input" />
            <span v-else class="form-input">{{ data.lxdh || '' }}</span>
          </td>
        </tr>
        <tr>
          <th>å·¥ä¼šè´¦æˆ·è´¦å·</th>
          <td>
            <input v-if="!printModeFlag" v-model="data.ghzhzh" disabled class="form-input" />
            <span v-else class="form-input">{{ data.ghzhzh || '' }}</span>
          </td>
          <th>å¼€æˆ·é“¶è¡Œåç§°</th>
          <td>
            <input v-if="!printModeFlag" v-model="data.khyhmc" disabled class="form-input" />
            <span v-else class="form-input">{{ data.khyhmc || '' }}</span>
          </td>
        </tr>
        <tr>
          <th>å·¥ä¼šè´¦æˆ·æˆ·å</th>
          <td>
            <input v-if="!printModeFlag" v-model="data.ghzhhm" disabled class="form-input" />
            <span v-else class="form-input">{{ data.ghzhhm || '' }}</span>
          </td>
          <th>å¼€æˆ·é“¶è¡Œ<br />ç½‘ç‚¹ä»£ç </th>
          <td>
            <input v-if="!printModeFlag" v-model="data.khyhwdm" disabled class="form-input" placeholder="éå¿…å¡«" />
            <span v-else class="form-input">{{ data.khyhwdm || '' }}</span>
          </td>
        </tr>
      </table>

      <!-- 2. æ±‡æ€»ç”³æŠ¥åŸå›  -->
      <table class="form-table">
        <tr>
          <th width="18%">æ±‡æ€»ç”³æŠ¥ç¼´çº³åŸå› </th>
          <td width="82%">
            <textarea v-if="!printModeFlag" v-model="data.hzbsjygy" disabled class="form-textarea" rows="5"></textarea>
            <span v-else class="form-textarea">{{ data.hzbsjygy || '' }}</span>
            <div class="sign-block">
              <div>ï¼ˆç›–ç« ï¼‰</div><br />
              <div>è´Ÿè´£äººï¼š
                <input v-if="!printModeFlag" v-model="data.fzrxm" disabled class="sign-input" />
                <span v-else class="sign-input">{{ data.fzrxm || '' }}</span>
              </div><br />
              <div>ç»åŠäººåŠè”ç³»ç”µè¯ï¼š
                <input v-if="!printModeFlag" v-model="data.jbrxm" disabled class="sign-input" />
                <span v-else class="sign-input">{{ data.jbrxm || '' }}</span>
                <span v-if="data.jbrdh" style="margin-left: 10px;">/</span>
                <input v-if="!printModeFlag && data.jbrdh" v-model="data.jbrdh" disabled class="sign-input"
                  style="width: 100px;" />
                <span v-else-if="data.jbrdh" class="sign-input" style="width: 100px;">{{ data.jbrdh || '' }}</span>
              </div>
              <div class="date-line">
                <span class="mini-input">{{ formatDatePart(data.sqrq, 'year') }}</span> å¹´
                <span class="mini-input">{{ formatDatePart(data.sqrq, 'month') }}</span> æœˆ
                <span class="mini-input">{{ formatDatePart(data.sqrq, 'day') }}</span> æ—¥
              </div>
            </div>
          </td>
        </tr>
      </table>

      <!-- 3. é™„ä»¶èµ„æ–™è¯´æ˜ -->
      <div class="attachment-note" style="text-align: center; border-top:none ;">
        é™„ä»¶èµ„æ–™ï¼šå…±
        <input v-if="!printModeFlag" v-model="data.fjgzs" disabled class="mini-input" type="number" />
        <span v-else class="mini-input">{{ data.fjgzs || 0 }}</span>
        æˆ·åˆ†æ”¯æœºæ„ï¼ˆä¸‹å±ä¼ä¸šã€å­å…¬å¸ï¼‰ç”³è¯·æ±‡æ€»ç¼´çº³å·¥ä¼šç»è´¹ã€‚
      </div>

      <!-- 4. å®¡æ ¸æ„è§åŒº -->
      <table class="form-table">
        <tr>
          <th width="20%">ä¸»ç®¡å·¥ä¼š<br />å®¡æ ¸æ„è§</th>
          <td width="30%">
            <div style="text-align: center;">ï¼ˆç›–ç« ï¼‰</div> <br />
            <textarea v-if="!printModeFlag" v-model="data.zgghsjy" disabled class="form-textarea" rows="2"
              style="margin-top:20px; margin-left: 40px; font-weight: bolder; font-size: 20px;"></textarea>
            <span v-else class="form-textarea" style="min-height: 60px;">{{ data.zgghsjy || '' }}</span>
            <div>è´Ÿè´£äººï¼š
              <input v-if="!printModeFlag" v-model="data.zgghsfzr" disabled class="sign-input" />
              <span v-else class="sign-input">{{ data.zgghsfzr || '' }}</span>
            </div>
            <br />
            <div>ç»åŠäººåŠè”ç³»ç”µè¯ï¼š
              <input v-if="!printModeFlag" v-model="data.zgghsjbr" disabled class="sign-input" />
              <span v-else class="sign-input">{{ data.zgghsjbr || '' }}</span>
              <span v-if="data.zgghsjbrdh" style="margin-left: 10px;">/</span>
              <input v-if="!printModeFlag && data.zgghsjbrdh" v-model="data.zgghsjbrdh" disabled class="sign-input"
                style="width: 100px;" />
              <span v-else-if="data.zgghsjbrdh" class="sign-input" style="width: 100px;">{{ data.zgghsjbrdh || ''
                }}</span>
            </div>
            <div class="date-line">
              <span class="mini-input">{{ formatDatePart(data.zgghsrq, 'year') }}</span> å¹´
              <span class="mini-input">{{ formatDatePart(data.zgghsrq, 'month') }}</span> æœˆ
              <span class="mini-input">{{ formatDatePart(data.zgghsrq, 'day') }}</span> æ—¥
            </div>
          </td>
          <th width="20%">çœæ€»å·¥ä¼š<br />å®¡æ ¸æ„è§</th>
          <td width="30%">
            <div style="text-align: center;">ï¼ˆç›–ç« ï¼‰</div><br />
            <textarea v-if="!printModeFlag" v-model="data.sghzsjy" disabled class="form-textarea" rows="2"
              style="margin-top:20px; margin-left: 40px; font-weight: bolder; font-size: 20px;"></textarea>
            <span v-else class="form-textarea" style="min-height: 60px;">{{ data.sghzsjy || '' }}</span>
            <br /> <br />
            <div>è´Ÿè´£äººï¼š
              <input v-if="!printModeFlag" v-model="data.sghsfzr" disabled class="sign-input" />
              <span v-else class="sign-input">{{ data.sghsfzr || '' }}</span>
            </div>
            <br />
            <div class="date-line">
              <span class="mini-input">{{ formatDatePart(data.sghsrq, 'year') }}</span> å¹´
              <span class="mini-input">{{ formatDatePart(data.sghsrq, 'month') }}</span> æœˆ
              <span class="mini-input">{{ formatDatePart(data.sghsrq, 'day') }}</span> æ—¥
            </div>
          </td>
        </tr>
      </table>

      <!-- æŒ‰é’®åŒº -->
      <div v-if="!printModeFlag" class="btn-group">
        <el-button type="success" class="print-btn " @click="openBranchDialog">æŸ¥çœ‹æœºæ„æ˜ç»†</el-button>
      </div>
    </div>

    <!-- åˆ†æ”¯æœºæ„æ˜ç»†é™„ä»¶è¡¨ï¼šæ‰“å°åœ¨ç¬¬äºŒé¡µA4ï¼ˆä»…æ‰“å°æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
    <!--  æ”¹ä¸ºä½¿ç”¨printModeFlag -->
    <div v-if="printModeFlag && branchList.length > 0" class="attachment-form-container" id="print-area-attachment">
      <div class="title-section">
        <h1 class="form-title">æ±‡æ€»ç¼´çº³åˆ†æ”¯æœºæ„ï¼ˆä¸‹å±ä¼ä¸šã€å­å…¬å¸ï¼‰æ˜ç»†è¡¨</h1>
      </div>
      <table class="form-table" style="width: 100%;">
        <tr style="background: #f5f5f5;">
          <th style="width: 8%;">åºå·</th>
          <th style="width: 20%;">ç¤¾ä¼šä¿¡ç”¨ä»£ç </th>
          <th style="width: 25%;">åˆ†æ”¯æœºæ„å…¨ç§°</th>
          <th style="width: 22%;">ä¸»ç®¡ç¨åŠ¡éƒ¨é—¨</th>
          <th style="width: 10%;">èŒå·¥äººæ•°</th>
          <th style="width: 15%;">æœˆå·¥èµ„æ€»é¢</th>
        </tr>
        <tr v-for="(item, index) in branchList" :key="item.id || index">
          <td style="text-align: center;">{{ index + 1 }}</td>
          <td>{{ item.fjgxyxdm || '' }}</td>
          <td>{{ item.fjgdwqc || '' }}</td>
          <td>{{ item.fjgzgsbm || '' }}</td>
          <td style="text-align: center;">{{ item.fjggzs || 0 }}</td>
          <td style="text-align: center;">{{ item.fjggzze || 0 }}</td>
        </tr>
      </table>
    </div>

    <!-- åˆ†æ”¯æœºæ„æ˜ç»†å¼¹çª— -->
    <el-dialog v-model="branchDialogVisible" title="åˆ†æ”¯æœºæ„æ˜ç»†" width="80%" height="90vh" top="10px" destroy-on-close
      append-to-body>
      <mxDetail :branch-list="branchList" @close="branchDialogVisible = false" />
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, watch } from 'vue'
import { ElMessage } from 'element-plus'
import { getHZFDetail, HzApplyDetailRespVO } from '@/api/lghjft/workflow/wfsqhzjf/index'
import mxDetail from './mxDetail.vue'

// å®šä¹‰åç«¯å¯èƒ½è¿”å›çš„æ—¥æœŸç±»å‹ï¼ˆæ•°ç»„/å­—ç¬¦ä¸²ï¼‰
type DateType = string | number[]

// æ‰©å±•æ¥å£
interface HzApplyDetailRespVOExt extends Omit<HzApplyDetailRespVO, 'detailList' | 'branchList'> {
  detailList?: Array<{
    fjgxyxdm: string
    fjgdwqc: string
    fjgzgsbm: string
    fjggzs: number
    fjggzze: number
    hzId?: number
    id?: number
  }>
  sqrq: string
  zgghsrq?: string
  sghsrq?: string
  fjgzs?: number
  hzbsjygy: string
  fzrxm?: string
  jbrxm?: string
  jbrdh?: string
  zgghsjy?: string
  zgghsfzr?: string
  zgghsjbr?: string
  zgghsjbrdh?: string
  sghzsjy?: string
  sghsfzr?: string
}

// æ¥æ”¶çˆ¶ç»„ä»¶å‚æ•°ï¼ˆID + æ‰“å°æ¨¡å¼ï¼‰
const props = defineProps<{
  id: number
  isPrintMode?: boolean // æ¥æ”¶PrintDialogä¼ é€’çš„æ‰“å°æ¨¡å¼
}>()

// åˆå§‹åŒ–è¡¨å•æ•°æ®
const data = ref<HzApplyDetailRespVOExt>({
  id: 0,
  xyxdm: '',
  dwqc: '',
  zgsbm: '',
  dwdz: '',
  ghfrdjzjh: '',
  ghqc: '',
  zzgzs: 0,
  ghyhs: 0,
  ghfzr: '',
  lxdh: '',
  ghzhzh: '',
  khyhmc: '',
  ghzhhm: '',
  khyhwdm: '',
  hzbsjygy: '',
  fzrxm: '',
  jbrxm: '',
  jbrdh: '',
  sqrq: '',
  fjgzs: 0,
  gzzt: '',
  attachments: [],
  detailList: [],
  zgghsjy: '',
  zgghgzz: '',
  zgghsfzr: '',
  zgghsjbr: '',
  zgghsjbrdh: '',
  zgghsrq: '',
  sghzsjy: '',
  sghgzz: '',
  sghsfzr: '',
  sghsrq: ''
})

// å“åº”å¼å˜é‡
const branchList = ref<Array<{
  fjgxyxdm: string
  fjgdwqc: string
  fjgzgsbm: string
  fjggzs: number
  fjggzze: number
  hzId?: number
  id?: number
}>>([])

// ğŸ”´ æ ¸å¿ƒä¿®å¤ï¼šé‡å‘½åå†…éƒ¨å˜é‡ï¼Œé¿å…å’Œpropsçš„isPrintModeå†²çª
const printModeFlag = ref<boolean>(false)
const branchDialogVisible = ref<boolean>(false)

// ç›‘å¬æ‰“å°æ¨¡å¼ï¼ˆä»PrintDialogä¼ é€’ï¼‰
watch(() => props.isPrintMode, (val) => {
  printModeFlag.value = val || false // ğŸ”´ èµ‹å€¼ç»™æ–°å˜é‡
}, { immediate: true })

// é¡µé¢æŒ‚è½½åŠ è½½æ•°æ®
onMounted(async () => {
  await loadDetail()
})

// åŠ è½½è¯¦æƒ…æ•°æ®
const loadDetail = async () => {
  try {
    const res = await getHZFDetail(props.id)
    console.log(res);

    const resData = res as HzApplyDetailRespVOExt
    data.value = { ...data.value, ...resData }

    // å¤„ç†åˆ†æ”¯æœºæ„æ˜ç»†
    if (resData.detailList && Array.isArray(resData.detailList) && resData.detailList.length > 0) {
      branchList.value = JSON.parse(JSON.stringify(resData.detailList))
    } else {
      branchList.value = []
      ElMessage.info('æš‚æ— åˆ†æ”¯æœºæ„æ˜ç»†æ•°æ®')
    }
  } catch (error) {
    console.error('æ•°æ®åŠ è½½å¤±è´¥ï¼š', error)
    ElMessage.error('ç”³è¯·è¡¨è¯¦æƒ…åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•')
  }
}

// æ ¼å¼åŒ–æ—¥æœŸå­—æ®µ
const formatDatePart = (date: DateType | undefined, type: 'year' | 'month' | 'day'): string => {
  if (!date) return ''
  if (Array.isArray(date) && date.length === 3) {
    const [year, month, day] = date
    if (type === 'year') return year.toString()
    if (type === 'month') return month.toString().padStart(2, '0')
    if (type === 'day') return day.toString().padStart(2, '0')
  }
  if (typeof date === 'string' && date.includes('-')) {
    const [year, month, day] = date.split('-')
    if (type === 'year') return year
    if (type === 'month') return month
    if (type === 'day') return day
  }
  return ''
}

// æ‰“å¼€åˆ†æ”¯æœºæ„å¼¹çª—
const openBranchDialog = () => {
  branchDialogVisible.value = true
}
</script>

<style scoped>
/* æ‰“å°å®¹å™¨æ€»æ ·å¼ */
.print-wrapper {
  width: 100%;
  min-height: 100vh;
}

/* ä¸»ç”³è¯·è¡¨å®¹å™¨ */
.main-form-container {
  max-width: 850px;
  margin: 30px auto;
  padding: 0 20px;
  font-family: "SimSun", serif;
  font-size: 17px;
  /* å…³é”®ï¼šå¼ºåˆ¶ä¸»è¡¨ååˆ†é¡µï¼Œé™„ä»¶è¡¨å•ç‹¬ä¸€é¡µ */
  page-break-after: always;
}

/* é™„ä»¶è¡¨å®¹å™¨ï¼ˆä»…æ‰“å°æ¨¡å¼æ˜¾ç¤ºï¼‰ */
.attachment-form-container {
  max-width: 850px;
  margin: 0 auto;
  padding: 0 20px;
  font-family: "SimSun", serif;
  font-size: 17px;
}

.title-section {
  text-align: center;
  margin-bottom: 25px;
}

.form-title {
  font-size: 22px;
  font-weight: bold;
  margin: 0;
  margin-bottom: 15px;
}

.form-table {
  border-bottom: none;
  width: 100%;
  border-collapse: collapse;
  border: 1px solid #000;
  page-break-inside: avoid;
}

.form-table th,
.form-table td {
  border: 1px solid #000;
  padding: 12px 8px;
  vertical-align: middle;
}

.form-table th {
  text-align: center;
  font-weight: normal;
  width: 20%;
  min-width: 120px;
}

.form-input,
.form-textarea {
  width: 100%;
  border: none;
  outline: none;
  background: transparent;
  font-family: inherit;
  font-size: inherit;
}

.form-textarea {
  resize: none;
  min-height: 120px;
  margin-bottom: 15px;
}

.mini-input {
  width: 50px;
  border: none;
  border-bottom: 1px dashed #000;
  outline: none;
  background: transparent;
  font-family: inherit;
  font-size: inherit;
  text-align: center;
}

.sign-block {
  padding-left: 20px;
}

.sign-input {
  border: none;
  border-bottom: 1px solid #000;
  outline: none;
  background: transparent;
  font-family: inherit;
  font-size: inherit;
  width: 120px;
  margin-left: 5px;
  text-align: center;
}

.date-line {
  margin-top: 15px;
  text-align: right;
}

.attachment-note {
  padding: 8px;
  border: 1px solid #000;
  border-bottom: none;
  margin-bottom: -1px;
}

.btn-group {
  display: flex;
  justify-content: center;
  gap: 30px;
  margin-top: 30px;
}

.print-btn {
  padding: 10px 20px;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
  height: 40px;
  line-height: 20px;
}

/* æ‰“å°é€‚é…æ ¸å¿ƒæ ·å¼ */
@media print {

  /* éšè—æŒ‰é’®å’Œå¼¹çª— */
  :deep(.el-button),
  .btn-group,
  :deep(.el-dialog),
  :deep(.el-dialog__wrapper) {
    display: none !important;
  }

  /* ä¸»è¡¨å’Œé™„ä»¶è¡¨éƒ½é€‚é…A4å®½åº¦ */
  .main-form-container,
  .attachment-form-container {
    max-width: 100% !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 0 10px !important;
  }

  /* å¼ºåˆ¶åˆ†é¡µç”Ÿæ•ˆ */
  .main-form-container {
    page-break-after: always !important;
  }
}
</style>